# ==============================================================
# Unified Nginx Configuration — Sobitas Project
# ==============================================================
#
# ONE file, mounted by BOTH internal nginx containers:
#
#   Container               Port        Domain              Upstream (PHP-FPM)
#   ─────────────────────── ────────    ──────────────────   ─────────────────────────
#   backend-nginx           8080:80     admin.protein.tn     sobitas-backend:9000
#   backend-nginx-v2        8083:80     admin.sobitas.tn     sobitas-backend-v2:9000
#
# Public traffic flow (via Nginx Proxy Manager):
#   admin.protein.tn  → NPM → 127.0.0.1:8080 → [Voyager block]  → sobitas-backend:9000
#   admin.sobitas.tn  → NPM → 127.0.0.1:8083 → [Filament block] → sobitas-backend-v2:9000
#
# ==============================================================

# ---- Gzip compression (applies to all server blocks) --------
gzip              on;
gzip_comp_level   5;
gzip_min_length   256;
gzip_proxied      any;
gzip_vary         on;
gzip_types
    application/atom+xml
    application/javascript
    application/json
    application/ld+json
    application/manifest+json
    application/rss+xml
    application/vnd.geo+json
    application/vnd.ms-fontobject
    application/x-font-ttf
    application/x-web-app-manifest+json
    application/xhtml+xml
    application/xml
    font/opentype
    image/bmp
    image/svg+xml
    image/x-icon
    text/cache-manifest
    text/css
    text/plain
    text/vcard
    text/vtt
    text/x-component
    text/x-cross-domain-policy
    text/xml;

# ==============================================================
# SERVER 1 — Voyager admin  (admin.protein.tn)
# Upstream: sobitas-backend:9000  |  Port: 8080
# ==============================================================
server {
    listen 80;
    server_name admin.protein.tn;

    root  /var/www/html/public;
    index index.php index.html;

    client_max_body_size 64M;

    # ---- Security headers ------------------------------------
    add_header X-Frame-Options        "SAMEORIGIN"                      always;
    add_header X-Content-Type-Options "nosniff"                         always;
    add_header Referrer-Policy        "strict-origin-when-cross-origin" always;
    add_header X-XSS-Protection       "1; mode=block"                  always;

    # ---- Placeholder SVG for missing images ------------------
    location = /placeholder.svg {
        root /var/www/html/public;
        internal;
    }

    # ---- Storage files ---------------------------------------
    location ^~ /storage/ {
        alias /var/www/html/storage/app/public/;
        access_log off;
        expires    30d;
        add_header Cache-Control "public";
        error_page 404 = /placeholder.svg;
    }

    # ---- Laravel routing -------------------------------------
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # ---- Static assets (fall through to PHP for Livewire/framework routes) ----
    location ~* \.(?:css|js|jpg|jpeg|gif|png|ico|svg|woff2?|ttf|eot|webp|map)$ {
        try_files $uri /index.php?$query_string;
        expires    30d;
        access_log off;
        add_header Cache-Control "public";
    }

    # ---- PHP-FPM → Voyager backend ---------------------------
    location ~ \.php$ {
        include        fastcgi_params;
        fastcgi_pass   sobitas-backend:9000;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param  DOCUMENT_ROOT   $document_root;
        fastcgi_param  REQUEST_URI     $request_uri;

        fastcgi_buffering        off;
        fastcgi_keep_conn        on;
        fastcgi_buffer_size      4k;
        fastcgi_buffers          8 4k;
        fastcgi_busy_buffers_size 8k;
        fastcgi_read_timeout     60s;
        fastcgi_send_timeout     60s;
        fastcgi_connect_timeout  5s;
    }

    # ---- Block sensitive / hidden files ----------------------
    location ~ /\.(?!well-known).* { deny all; }
    location ~* /(composer\.(json|lock)|package\.json|\.env|webpack\.mix\.js|vite\.config\.js)$ { deny all; }
}

# ==============================================================
# SERVER 2 — Filament admin v2  (admin.sobitas.tn)
# Upstream: sobitas-backend-v2:9000  |  Port: 8083
# ==============================================================
server {
    listen 80 default_server;
    server_name admin.sobitas.tn _;

    root  /var/www/html/public;
    index index.php index.html;

    client_max_body_size 64M;

    # ---- Security headers ------------------------------------
    add_header X-Frame-Options        "SAMEORIGIN"                      always;
    add_header X-Content-Type-Options "nosniff"                         always;
    add_header Referrer-Policy        "strict-origin-when-cross-origin" always;
    add_header X-XSS-Protection       "1; mode=block"                  always;

    # ---- Placeholder SVG for missing images ------------------
    location = /placeholder.svg {
        root /var/www/html/public;
        internal;
    }

    # ---- Storage files ---------------------------------------
    location ^~ /storage/ {
        alias /var/www/html/storage/app/public/;
        access_log off;
        expires    30d;
        add_header Cache-Control "public";
        error_page 404 = /placeholder.svg;
    }

    # ---- Vite build directory (immutable hashed filenames) ---
    location ^~ /build/ {
        try_files $uri =404;
        expires    1y;
        access_log off;
        add_header Cache-Control "public, immutable";
    }

    # ---- Laravel routing -------------------------------------
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # ---- Static assets (fall through to PHP for Filament/Livewire routes) ----
    location ~* \.(?:css|js|jpg|jpeg|gif|png|ico|svg|woff2?|ttf|eot|webp|map)$ {
        try_files $uri /index.php?$query_string;
        expires    30d;
        access_log off;
        add_header Cache-Control "public";
    }

    # ---- PHP-FPM → Filament backend v2 ----------------------
    location ~ \.php$ {
        include        fastcgi_params;
        fastcgi_pass   sobitas-backend-v2:9000;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param  DOCUMENT_ROOT   $document_root;
        fastcgi_param  REQUEST_URI     $request_uri;

        fastcgi_buffering        off;
        fastcgi_keep_conn        on;
        fastcgi_buffer_size      4k;
        fastcgi_buffers          8 4k;
        fastcgi_busy_buffers_size 8k;
        fastcgi_read_timeout     60s;
        fastcgi_send_timeout     60s;
        fastcgi_connect_timeout  5s;
    }

    # ---- Block sensitive / hidden files ----------------------
    location ~ /\.(?!well-known).* { deny all; }
    location ~* /(composer\.(json|lock)|package\.json|\.env|webpack\.mix\.js|vite\.config\.js)$ { deny all; }
}
