# Custom log format with detailed timing fields
# rt = request_time (total time from Nginx perspective)
# urt = upstream_response_time (time to receive full response from PHP-FPM)
# uht = upstream_header_time (time to receive first byte from PHP-FPM - TTFB)
# uct = upstream_connect_time (time to establish connection to PHP-FPM)
log_format detailed_timing '$remote_addr - $remote_user [$time_local] '
    '"$request" $status $body_bytes_sent '
    '"$http_referer" "$http_user_agent" '
    'rt=$request_time '
    'urt=$upstream_response_time '
    'uht=$upstream_header_time '
    'uct=$upstream_connect_time '
    'cache=$upstream_cache_status';

server {
    listen 80 default_server;
    server_name admin.sobitas.tn admin.protein.tn localhost 127.0.0.1 145.223.118.9 _;

    root /var/www/html/public;
    index index.php index.html;
    
    # CRITICAL: Use detailed timing log format
    access_log /var/log/nginx/access.log detailed_timing;
    error_log /var/log/nginx/error.log;

    # Increase max body size for file uploads
    client_max_body_size 64M;

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript image/svg+xml;
    gzip_min_length 1024;
    gzip_vary on;

    # PHP-FPM status (internal only - MUST come before catch-all location)
    location = /status {
        access_log off;
        allow 127.0.0.1;
        allow 172.16.0.0/12;  # Docker network
        allow 10.0.0.0/8;     # Additional Docker networks
        deny all;
        include fastcgi_params;
        fastcgi_pass sobitas-backend:9000;
        # Status endpoint is handled by PHP-FPM directly, not a PHP script
        fastcgi_param SCRIPT_FILENAME "";
        fastcgi_param REQUEST_URI /status;
        fastcgi_param QUERY_STRING "";
    }

    # PHP-FPM ping (for health checks - MUST come before catch-all location)
    location = /ping {
        access_log off;
        allow 127.0.0.1;
        allow 172.16.0.0/12;  # Docker network
        allow 10.0.0.0/8;     # Additional Docker networks
        deny all;
        include fastcgi_params;
        fastcgi_pass sobitas-backend:9000;
        # Ping endpoint is handled by PHP-FPM directly
        fastcgi_param SCRIPT_FILENAME "";
        fastcgi_param REQUEST_URI /ping;
        fastcgi_param QUERY_STRING "";
    }

    # Placeholder for missing storage files (internal redirect only)
    location = /placeholder.svg {
        root /var/www/html/public;
        internal;
    }

    # Serve storage files (when proxied from main nginx as /storage/...)
    # If file does not exist, serve placeholder so images don't break
    location /storage/ {
        alias /var/www/html/storage/app/public/;
        access_log off;
        expires 30d;
        add_header Cache-Control "public";
        error_page 404 = /placeholder.svg;
    }

    # Laravel routing
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # API routes
    location /api/ {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Admin route (Filament)
    location /admin {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Filament assets
    location /filament/ {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Livewire
    location /livewire/ {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Static assets â€” serve from disk if found, otherwise fall through to PHP
    # (Livewire, Filament, and other framework assets are served via PHP routes)
    location ~* \.(?:jpg|jpeg|gif|png|ico|css|js|svg|woff|woff2|ttf|eot|webp)$ {
        try_files $uri /index.php?$query_string;
        expires 30d;
        access_log off;
        add_header Cache-Control "public";
    }

    # PHP-FPM (explicit REQUEST_URI so Laravel routing works behind proxy)
    # CRITICAL: Optimized for low latency (reduce Nginx<->PHP-FPM overhead)
    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass sobitas-backend:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $document_root;
        fastcgi_param REQUEST_URI $request_uri;
        
        # CRITICAL: Disable buffering to reduce latency (stream response immediately)
        # This eliminates the delay between PHP-FPM sending data and Nginx forwarding it
        fastcgi_buffering off;
        
        # Enable keepalive connections to PHP-FPM (reuse connections, avoid handshake overhead)
        fastcgi_keep_conn on;
        
        # Reduce buffer sizes for faster first byte (smaller buffers = less waiting)
        fastcgi_buffer_size 4k;
        fastcgi_buffers 8 4k;
        fastcgi_busy_buffers_size 8k;
        
        # Increase read timeout to prevent premature disconnects
        fastcgi_read_timeout 60s;
        
        # Send timeout (time to send request to PHP-FPM)
        fastcgi_send_timeout 60s;
        
        # Connect timeout (time to establish connection to PHP-FPM)
        fastcgi_connect_timeout 5s;
    }

    # Block hidden files
    location ~ /\.(?!well-known).* {
        deny all;
    }
}
