services:
  # -------------------------
  # Application Database
  # -------------------------
  mysql:
    image: mysql:8.0
    container_name: sobitas-mysql
    restart: unless-stopped
    env_file:
      - .env
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql-data:/var/lib/mysql
      - ./newest.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - sobitas-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 10

  # -------------------------
  # PHP-FPM (Laravel Backend + Admin)
  # -------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sobitas-backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${MYSQL_DATABASE:-protein_db}
      DB_USERNAME: ${MYSQL_USER:-laravel}
      DB_PASSWORD: ${MYSQL_PASSWORD:-secret}
    networks:
      - sobitas-net
    expose:
      - "9000"
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "php -v >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    volumes:
      - ./backend:/var/www/html:delegated
      - backend-vendor:/var/www/html/vendor
      - backend-bootstrap-cache:/var/www/html/bootstrap/cache

  # -------------------------
  # PHP-FPM (Laravel Demo + Filament Admin)
  # -------------------------
  demo:
    build:
      context: ./demo
      dockerfile: Dockerfile
    container_name: sobitas-demo
    restart: unless-stopped
    environment:
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${MYSQL_DATABASE:-protein_db}
      DB_USERNAME: ${MYSQL_USER:-laravel}
      DB_PASSWORD: ${MYSQL_PASSWORD:-secret}
      APP_ENV: ${APP_ENV:-local}
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_KEY: base64:Tb3NC6XoiJjpiwFAGnvSXVIIHZPRdOLwCza7Idgr5n4=
      APP_URL: http://localhost:8082
      ASSET_URL: ""
      APP_LOCALE: fr 
    networks:
      - sobitas-net
    expose:
      - "9000"
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "php -v >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    volumes:
      - ./demo:/var/www/html:delegated
      - demo-vendor:/var/www/html/vendor
      - demo-bootstrap-cache:/var/www/html/bootstrap/cache

  # -------------------------
  # Nginx for Laravel (backend / admin)
  # -------------------------
  laravel-nginx:
    image: nginx:stable
    container_name: sobitas-laravel-nginx
    restart: unless-stopped
    ports:
      - "8081:80"
    volumes:
      - ./backend:/var/www/html:delegated
      - ./backend/storage:/var/www/html/storage
      - ./nginx/laravel.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - sobitas-net
    depends_on:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "nginx -t >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  # -------------------------
  # PHP-FPM (Laravel Backend #2 - V2 Instance)
  # -------------------------
  backend-v2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sobitas-backend-v2
    restart: unless-stopped
    env_file:
      - .env
    environment:
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${MYSQL_DATABASE:-protein_db}
      DB_USERNAME: ${MYSQL_USER:-laravel}
      DB_PASSWORD: ${MYSQL_PASSWORD:-secret}
    networks:
      - sobitas-net
    expose:
      - "9000"
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "php -v >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    volumes:
      - ./backend:/var/www/html:delegated
      - backend-v2-vendor:/var/www/html/vendor
      - backend-v2-bootstrap-cache:/var/www/html/bootstrap/cache

  # -------------------------
  # Nginx for Laravel Backend #2 (V2 Instance)
  # -------------------------
  laravel-nginx-v2:
    image: nginx:stable
    container_name: sobitas-laravel-nginx-v2
    restart: unless-stopped
    ports:
      - "8083:80"
    volumes:
      - ./backend:/var/www/html:delegated
      - ./backend/storage:/var/www/html/storage
      - ./nginx/laravel-v2.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - sobitas-net
    depends_on:
      - backend-v2
    healthcheck:
      test: ["CMD-SHELL", "nginx -t >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  # -------------------------
  # Nginx for Demo (Filament Admin)
  # -------------------------
  demo-nginx:
    image: nginx:stable
    container_name: sobitas-demo-nginx
    restart: unless-stopped
    ports:
      - "8082:80"
    volumes:
      - ./demo:/var/www/html:delegated
      - ./demo/storage:/var/www/html/storage
      - ./nginx/demo.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - sobitas-net
    depends_on:
      - demo
    healthcheck:
      test: ["CMD-SHELL", "nginx -t >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  # -------------------------
  # Next.js Frontend
  # -------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      # No build args: Next.js uses frontend/.env (API + storage from deployed backend)
    container_name: sobitas-frontend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      # Direct external API access
      NEXT_PUBLIC_API_URL: https://admin.protein.tn/api
      NEXT_PUBLIC_STORAGE_URL: https://admin.protein.tn/storage
    ports:
      - "3001:3000"
    networks:
      - sobitas-net
    depends_on:
      - laravel-nginx

  # -------------------------
  # Nginx reverse proxy (frontend + backend on port 80)
  # -------------------------
  nginx:
    image: nginx:stable
    container_name: sobitas-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/sobitas-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - sobitas-net
    depends_on:
      - frontend
      - laravel-nginx
      - demo-nginx
    healthcheck:
      test: ["CMD-SHELL", "nginx -t >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  # -------------------------
  # Nginx Proxy Manager (optional - for SSL / multiple domains)
  # -------------------------
  npm:
    image: jc21/nginx-proxy-manager:latest
    container_name: sobitas-npm
    restart: unless-stopped
    ports:
      - "81:81"
      - "8080:80"
      - "8443:443"
    environment:
      DB_MYSQL_HOST: npm-db
      DB_MYSQL_PORT: 3306
      DB_MYSQL_USER: npm
      DB_MYSQL_PASSWORD: npm
      DB_MYSQL_NAME: npm
    volumes:
      - npm-data:/data
      - npm-letsencrypt:/etc/letsencrypt
      - ./letsencrypt/credentials:/etc/letsencrypt/credentials
    networks:
      - sobitas-net
    depends_on:
      - npm-db
    profiles:
      - npm

  npm-db:
    image: mysql:8.0
    container_name: sobitas-npm-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: npmroot
      MYSQL_DATABASE: npm
      MYSQL_USER: npm
      MYSQL_PASSWORD: npm
    volumes:
      - npm-db-data:/var/lib/mysql
    networks:
      - sobitas-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-u", "npm", "-pnpm"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - npm

  # -------------------------
  # Rename Images Python Script
  # -------------------------
  rename-images:
    build:
      context: ./rename-images
      dockerfile: Dockerfile
    container_name: sobitas-rename-images
    restart: "no"
    networks:
      - sobitas-net
    depends_on:
      - mysql
      - backend
    environment:
      DB_HOST: mysql
      DB_USER: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      DB_NAME: ${MYSQL_DATABASE}
      PUBLIC_DIR: /app
    volumes:
      - ./backend/storage/app/public/produits:/app/produits:delegated
    profiles:
      - tools

volumes:
  mysql-data:
  backend-vendor:
  backend-bootstrap-cache:
  backend-v2-vendor:
  backend-v2-bootstrap-cache:
  demo-vendor:
  demo-bootstrap-cache:
  npm-data:
  npm-letsencrypt:
  npm-db-data:

networks:
  sobitas-net:
    driver: bridge
