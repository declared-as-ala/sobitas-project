name: Deploy Backend V2 (Filament)

on:
  push:
    branches: [main]
    paths:
      - ".github/workflows/deploy-backend-v2.yml"
      # add paths that affect the docker image build if you want
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy on VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          timeout: 600s
          command_timeout: 600s
          script: |
            set -e

            cd /root/sobitas-project

            echo "== Pull latest v2 image =="
            docker pull ghcr.io/declared-as-ala/sobitas-backend-v2:latest

            echo "== Recreate backend-v2 & init public assets =="
            docker compose up -d --force-recreate backend-v2 backend-v2-public-init

            echo "== Recreate nginx v2 (serve public) =="
            docker compose up -d --force-recreate backend-nginx-v2

            echo "== Run Laravel maintenance =="
            docker exec -t sobitas-backend-v2 sh -lc "php artisan migrate --force || true"
            docker exec -t sobitas-backend-v2 sh -lc "php artisan optimize:clear || true"
            docker exec -t sobitas-backend-v2 sh -lc "php artisan config:cache || true"
            docker exec -t sobitas-backend-v2 sh -lc "php artisan route:cache || true"
            docker exec -t sobitas-backend-v2 sh -lc "php artisan view:cache || true"

            echo "== Done âœ… =="
            docker ps --format 'table {{.Names}}\t{{.Status}}' | grep -E 'sobitas-backend-v2|sobitas-laravel-nginx-v2' || true
